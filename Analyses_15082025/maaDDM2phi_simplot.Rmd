---
title: "maaDDM2phi_plot"
author: "Jennifer March (jennifer.march@uni-hamburg.de)"
output: html_document
date: "2025-07-31"
---

This script is to simulate the decision making process as predicted by the maaDDM2phi.
Changes in the parameters and the options underlying attribute values, as well as the fixation proportions result in changes in the decision trajectory

### 1 Preparations
```{r}
# Load required libraries
library(ggplot2)
library(dplyr)


myTheme <- theme(
  axis.line = element_line(colour = "black"), 
  panel.grid.major = element_blank(), 
  panel.grid.minor = element_blank(),  
  panel.border = element_blank(),   
  panel.background = element_blank(),
  text=element_text(size=16, colour = "black"), 
  axis.title.x = element_text(size=20, face="bold", colour = "black"), 
  axis.title.y = element_text( size=20, face="bold", colour = "black"),
  axis.text = element_text(size=16),
  strip.text =  element_text( size=16),
  strip.background = element_rect(fill = "white", colour = "black"),
  legend.background = element_rect(colour = "black"),
  legend.key = element_blank(),
  legend.key.size = unit(3, "lines"))
```



### 2 Functions and Parameters
```{r}
# Set up parameters with drastic phi examples
fixProps <- matrix(c(0.3, 0.4, 0.2, 0.1), nrow = 1)

# Attribute values
attribute1A <- 5
attribute1B <- 3
attribute2A <- 4
attribute2B <- 6

# Fixed parameters
weight <- c(0.3,0.5,0.7)
theta <- 0.75
drift_scaling <- 2 
phi <- c(0.1,0.5,0.9)

# DDM parameters
a <- 8.0  # decision threshold
z <- 4.0  # starting point (bias)
noise_sd <- 0.3  # noise standard deviation
ter <- 0.25  # non-decision time

# Fixation duration parameters - make them more visible
mean_fixation_duration <- 0.3  # increased from 0.3
min_fixation_duration <- 0.1  # increased from 0.1

# Function to calculate drift rate for a specific fixation type
calculate_drift_fixation <- function(fixation_type, weight, theta, phi1, phi2,
                                   attribute1A, attribute1B, attribute2A, attribute2B, 
                                   drift_scaling) {
  
  # Calculate drift based on fixation type (1-4 corresponding to fixProps columns)
  if (fixation_type == 1) {
    valueDifference <- weight*(attribute1A-theta*attribute1B)+(1-weight)*phi1*(attribute2A-theta*attribute2B)
  } else if (fixation_type == 2) {
    valueDifference <- weight*(theta*attribute1A-attribute1B)+(1-weight)*phi1*(theta*attribute2A-attribute2B)
  } else if (fixation_type == 3) {
    valueDifference <- weight*phi2*(attribute1A-theta*attribute1B)+(1-weight)*(attribute2A-theta*attribute2B)
  } else if (fixation_type == 4) {
    valueDifference <- weight*phi2*(theta*attribute1A-attribute1B)+(1-weight)*(theta*attribute2A-attribute2B)
  }
  
  return(drift_scaling * valueDifference)
}

# Function to generate fixed fixation sequence (same for all trials)
generate_fixed_fixation_sequence <- function(total_time, ter, fixation_duration = 0.25) {
  # Create fixed sequence: 250ms each on fixations 1, 2, 3, 4, then repeat
  fixation_times <- c()
  fixation_types <- c()
  
  current_time <- ter  # Start after non-decision time
  fixation_order <- c(1, 2, 3, 4)  # Always the same order
  fixation_index <- 1
  
  # Add initial non-fixation period
  if (ter > 0) {
    fixation_times <- c(0, ter)
    fixation_types <- c(0, 0)  # No fixation during ter
  }
  
  while (current_time < total_time) {
    # Determine duration (don't exceed total time)
    duration <- min(fixation_duration, total_time - current_time)
    if (duration < 0.05) break  # Stop if remaining time is too small
    
    # Get current fixation type
    fixation_type <- fixation_order[((fixation_index - 1) %% 4) + 1]
    
    fixation_times <- c(fixation_times, current_time, current_time + duration)
    fixation_types <- c(fixation_types, fixation_type, fixation_type)
    
    current_time <- current_time + duration
    fixation_index <- fixation_index + 1
  }
  
  return(data.frame(time = fixation_times, fixation_type = fixation_types))
}

simulate_2phi_sequential <- function(weight, theta, phi1, phi2, a, z, noise_sd, ter, 
                                   n_trials, max_time, attribute1A, attribute1B, 
                                   attribute2A, attribute2B, drift_scaling, fixProps,
                                   fixation_duration = 0.9) {
  dt <- 0.01  # time step
  time_steps <- seq(0, max_time, dt)
  
  trajectories <- list()
  
  for (trial in 1:n_trials) {
    evidence_trajectory <- numeric(length(time_steps))
    fixation_trajectory <- numeric(length(time_steps))
    
    # Generate FIXED fixation sequence (same for all trials)
    fixation_seq <- generate_fixed_fixation_sequence(max_time, ter, fixation_duration)
    
    # During non-decision time: evidence stays at starting point
    ter_steps <- which(time_steps <= ter)
    evidence_trajectory[ter_steps] <- z
    fixation_trajectory[ter_steps] <- 0  # no fixation during ter
    
    # After non-decision time: evidence accumulation begins
    evidence <- z  # start evidence accumulation at bias point
    
    for (t in (max(ter_steps) + 1):length(time_steps)) {
      current_time <- time_steps[t]
      
      # Determine current fixation type
      current_fixation <- 0
      for (i in 1:(nrow(fixation_seq)-1)) {
        if (current_time >= fixation_seq$time[i] && current_time < fixation_seq$time[i+1]) {
          current_fixation <- fixation_seq$fixation_type[i]
          break
        }
      }
      
      # Calculate drift rate based on current fixation
      if (current_fixation > 0) {
        current_drift <- calculate_drift_fixation(current_fixation, weight, theta, phi1, phi2,
                                                 attribute1A, attribute1B, attribute2A, attribute2B, 
                                                 drift_scaling)
      } else {
        current_drift <- 0  # no drift during transitions or ter
      }
      
      # Add drift and noise (reduce noise to prevent boundary crossings)
      evidence <- evidence + current_drift * dt + rnorm(1, 0, noise_sd * sqrt(dt) * 0.3)  # Reduced noise
      evidence_trajectory[t] <- evidence
      fixation_trajectory[t] <- current_fixation
      
      # Optional: Check if boundary is reached only at the very end
      if (t > length(time_steps) * 0.95) {  # Only allow boundary crossing in last 5% of time
        if (evidence >= a || evidence <= 0) {
          # Fill remaining time with boundary value
          boundary_value <- ifelse(evidence >= a, a, 0)
          if (t < length(time_steps)) {
            evidence_trajectory[(t+1):length(time_steps)] <- boundary_value
            fixation_trajectory[(t+1):length(time_steps)] <- current_fixation
          }
          break
        }
      } else {
        # Prevent boundary crossing by constraining evidence
        evidence <- max(0.1, min(a - 0.1, evidence))
        evidence_trajectory[t] <- evidence
      }
    }
    
    trajectories[[trial]] <- data.frame(
      time = time_steps,
      evidence = evidence_trajectory,
      fixation = fixation_trajectory,
      trial = trial
    )
  }
  
  return(do.call(rbind, trajectories))
}
```

### 3 Simulate
```{r}
# Simulate trajectories for each scenario with FIXED fixation sequences

fixation_duration <- 0.95

traj1 <- simulate_2phi_sequential(weight[1], theta, phi[1], phi[3], a, z, noise_sd, ter, 1, 4,
                                 attribute1A, attribute1B, attribute2A, attribute2B, drift_scaling,
                                 fixProps, fixation_duration)

traj2 <- simulate_2phi_sequential(weight[1], theta, phi[3], phi[1], a, z, noise_sd, ter, 1, 4,
                                 attribute1A, attribute1B, attribute2A, attribute2B, drift_scaling,
                                 fixProps, fixation_duration)

traj3 <- simulate_2phi_sequential(weight[1], theta, phi[2], phi[2], a, z, noise_sd, ter, 1, 4,
                                 attribute1A, attribute1B, attribute2A, attribute2B, drift_scaling,
                                 fixProps, fixation_duration)

traj4 <- simulate_2phi_sequential(weight[2], theta, phi[1], phi[3], a, z, noise_sd, ter, 1, 4,
                                 attribute1A, attribute1B, attribute2A, attribute2B, drift_scaling,
                                 fixProps, fixation_duration)

traj5 <- simulate_2phi_sequential(weight[2], theta, phi[3], phi[1], a, z, noise_sd, ter, 1, 4,
                                 attribute1A, attribute1B, attribute2A, attribute2B, drift_scaling,
                                 fixProps, fixation_duration)

traj6 <- simulate_2phi_sequential(weight[2], theta, phi[2], phi[2], a, z, noise_sd, ter, 1, 4,
                                 attribute1A, attribute1B, attribute2A, attribute2B, drift_scaling,
                                 fixProps, fixation_duration)

traj7 <- simulate_2phi_sequential(weight[3], theta, phi[1], phi[3], a, z, noise_sd, ter, 1, 4,
                                 attribute1A, attribute1B, attribute2A, attribute2B, drift_scaling,
                                 fixProps, fixation_duration)

traj8 <- simulate_2phi_sequential(weight[3], theta, phi[3], phi[1], a, z, noise_sd, ter, 1, 4,
                                 attribute1A, attribute1B, attribute2A, attribute2B, drift_scaling,
                                 fixProps, fixation_duration)

traj9 <- simulate_2phi_sequential(weight[3], theta, phi[2], phi[2], a, z, noise_sd, ter, 1, 4,
                                 attribute1A, attribute1B, attribute2A, attribute2B, drift_scaling,
                                 fixProps, fixation_duration)

# Add scenario labels
# traj1$scenario <- "w=0.3, ϕ1=0.1, ϕ2=0.9"
# traj2$scenario <- "w=0.3, ϕ1=0.5, ϕ2=0.5"
# traj3$scenario <- "w=0.3, ϕ1=0.9, ϕ2=0.1"
# traj4$scenario <- "w=0.5, ϕ1=0.1, ϕ2=0.9"
traj5$scenario <- "w=0.5, ϕ1=0.5, ϕ2=0.5"
traj6$scenario <- "w=0.5, ϕ1=0.9, ϕ2=0.1"
# traj7$scenario <- "w=0.7, ϕ1=0.1, ϕ2=0.9"
traj8$scenario <- "w=0.7, ϕ1=0.5, ϕ2=0.5"
# traj9$scenario <- "w=0.7, ϕ1=0.9, ϕ2=0.1"

# Combine all trajectories
# all_trajectories <- rbind(traj1, traj2, traj3, traj4, traj5, traj6, traj7, traj8, traj9)
all_trajectories <- rbind(traj5, traj6, traj8)
```

### 4 Plot
```{r}
library("ggplot2")

# Create the drift diffusion plot with one panel per scenario
p <- ggplot(all_trajectories, aes(x = time, y = evidence, group = interaction(trial, scenario))) +

  
  # Add background colors for different fixation types - make them more distinct
  geom_rect(data = all_trajectories[all_trajectories$fixation == 1,],
            aes(xmin = time - 0.01, xmax = time + 0.01, ymin = -0.5, ymax = a + 0.5),
            fill = "mistyrose", alpha = 0.6, inherit.aes = FALSE) +
  geom_rect(data = all_trajectories[all_trajectories$fixation == 2,],
            aes(xmin = time - 0.01, xmax = time + 0.01, ymin = -0.5, ymax = a + 0.5),
            fill = "lightyellow", alpha = 0.6, inherit.aes = FALSE) +
  geom_rect(data = all_trajectories[all_trajectories$fixation == 3,],
            aes(xmin = time - 0.01, xmax = time + 0.01, ymin = -0.5, ymax = a + 0.5),
            fill = "lightpink", alpha = 0.6, inherit.aes = FALSE) +
  geom_rect(data = all_trajectories[all_trajectories$fixation == 4,],
            aes(xmin = time - 0.01, xmax = time + 0.01, ymin = -0.5, ymax = a + 0.5),
            fill = "lightgoldenrod", alpha = 0.6, inherit.aes = FALSE) +
  
  # Add trajectories - single line per panel
  geom_line(color = "black", alpha = 1, size = 1) +
  
  # Add decision boundaries
  geom_hline(yintercept = a, linetype = "solid", color = "black", size = 1.2, alpha = 0.8) +
  geom_hline(yintercept = 0, linetype = "solid", color = "black", size = 1.2, alpha = 0.8) +
  geom_hline(yintercept = z, linetype = "dashed", color = "black", size = 0.8, alpha = 0.6) +
  
  # Add non-decision time region
  annotate("rect", xmin = 0, xmax = ter, ymin = -0.1, ymax = a + 0.1, 
           alpha = 0.3, fill = "gray") +
  
  # Facet by scenario for no overlap
  facet_wrap(~ scenario, scales = "free_x", ncol = 3) +
  
  # Labels and theme
  labs(
    title = "Parameter Effects in maaDDM2phi - Fixed Fixation Sequences",
    x = "Time",
    y = "Evidence Accumulation",
  ) +
  myTheme +
  theme(
    strip.text = element_text(size = 10, face = "bold"),
    axis.text = element_text(size = 9),
    axis.title = element_text(size = 11),
    plot.title = element_text(size = 13),
    plot.subtitle = element_text(size = 10), 
    axis.text.y=element_blank()
  ) +
  ylim(-0.5, a + 0.5) +
  xlim(0, 4.2)

p


ggsave("maaDDM2phi_sequential_simplot.png", p, height= 6, width=12, dpi=300)

```



