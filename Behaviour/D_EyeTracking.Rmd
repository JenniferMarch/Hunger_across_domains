---
title: "Eye-Track"
output: html_document
date: "2024-10-09"
author: "Jennifer March (jennifer.march@uni-hamburg.de)"
---

## Info 
Eye-tracking for Manuscript on the effect of hunger state on attention and choice across domains (R version 4.4.1 (2024-06-14))
Includes: 
* Relationship between attention and choice (across 3 tasks: food, social, Intertemporal discounting) on both option and attribute level
* Relationship between hunger state attention (across 3 tasks: food, social, Intertemporal discounting) on both option and attribute level
* First and last fixations
* Fixation Transitions (Payne Index)

--> Output: Fig 3, Fig S7, Fig S8 and relevant stats

## 1 Preperations

### 1.1 Chreate Theme for figures
```{r}
library(ggplot2)
myTheme <- theme(
  axis.line = element_line(colour = "black"), 
  panel.grid.major = element_blank(), 
  panel.grid.minor = element_blank(),  
  panel.border = element_blank(),   
  panel.background = element_blank(),
  text=element_text(size=16, colour = "black"), 
  axis.title.x = element_text(size=20, face="bold", colour = "black"), 
  axis.title.y = element_text( size=20, face="bold", colour = "black"),
  axis.text = element_text(size=16),
  strip.text =  element_text( size=16),
  strip.background = element_rect(fill = "white", colour = "black"),
  legend.background = element_rect(colour = "black"),
  legend.key = element_blank(),
  legend.key.size = unit(3, "lines"))
```

### 1.2 Load Pre-processed Data
```{r}
load('had_data_2.RData')
load("food_modeling_data.RData")
load("social_modeling_data.RData")
load("discount_modeling_data.RData")
```


## 2 Food
### 2.1 Choose taste given dwell time (Fig 3a)
```{r}
library(dplyr)

p1 <- ggplot(data_combined2, aes(x =dwelldiff_taste_rel, y = choice2, color = condition, fill=condition)) +
  geom_smooth(method = "glm", se = TRUE,  method.args = list(family=binomial), linetype = "solid", alpha=0.3) +
  scale_color_manual(values = c("gold", "cornflowerblue")) +
  scale_fill_manual(values = c("gold", "cornflowerblue")) +  # Set fill colors for each condition
  labs(x = expression(bold(paste("DT", Delta, "(option"[paste("tasty")], " - option"[paste("healthy")], ")"))),, y = "P(Tasty Choice)") +
  geom_hline(yintercept = 0.5, color = "black", linetype = "dashed") +
  geom_vline(xintercept = 0, color = "black", linetype = "dashed") +  
  ylim(0,1)+
  myTheme+
  theme(panel.background = element_rect(color = "magenta", linewidth = 2, fill = NA),
        plot.margin = margin(10, 10, 20, 10))
ggsave("pchoice_dwelltime.png",  width = 8, height = 6, plot = last_plot(), dpi = 300)
p1


```

### 2.2 choose tasty given dwell time nutri
```{r}
library(ggdist)
summary_taste <- data_combined2 %>%
  group_by(nutri, condition, subject) %>%
  summarise(mean_prob_taste = mean(choice2),
            std_error_time = sd(choice2) / sqrt(n()))


p2 <- ggplot(summary_taste, aes(x = as.factor(nutri), y = mean_prob_taste, fill = condition, color = condition)) +
  # Add the cloud (violin plot)
  stat_halfeye(
    adjust = 0.5,
    width = 0.5,
    alpha = 0.5,
    justification = -0.2,
    .width = 0,
    point_colour = NA,
    position = position_dodge(width = 0.8)  # Add dodge to violin plots
  ) +
  # Add the rain (individual points)
  geom_point(
    position = position_jitterdodge(dodge.width = 0.8, jitter.width = 0.15),
    size = 1,
    alpha = 0.5
  ) +
  # Add boxplot
  geom_boxplot(
    width = 0.1,
    position = position_dodge(width = 0.8),  # Make sure dodge width matches
    outlier.shape = NA,
    alpha = 0.5
  ) +
  # Customize colors
  scale_fill_manual(
    values = c(
      "sated" = "cornflowerblue",
      "hungry" = "gold"
    )
  ) +
  scale_color_manual(
    values = c(
      "sated" = "cornflowerblue",
      "hungry" = "gold"
    )
  ) +
  geom_hline(yintercept = 0.5, color = "black", linetype = "dashed") +
  # Customize labels and theme
  labs(
    x = "Nutri Score Fixated",
    y = "P(Tasty Choice)",
    fill = "Condition",
    color = "Condition"
  ) +
  myTheme+
  theme(panel.background = element_rect(color = "magenta", linewidth = 2, fill = NA),
        plot.margin = margin(10, 10, 20, 10))
ggsave("pchoice_dwelltime_nutri.png",  width = 8, height = 6, plot = last_plot(), dpi = 300)
p2

```

### 2.3 Proportion DT Food Image by hunger state
```{r}
data_combined2$att_food <- (data_combined2$foodleft_time + data_combined2$foodright_time) /(data_combined2$foodleft_time + data_combined2$foodright_time + data_combined2$nutrileft_time + data_combined2$nutriright_time)

combined_summary_food <- data_combined2 %>%
  group_by(subject, condition) %>%
  summarise(mean_att_food = mean(att_food),
            std_error = sd(att_food) / sqrt(n()))


dt_food <- ggplot(combined_summary_food, aes(x = condition, y = mean_att_food, fill = condition)) +
  # Add the cloud (violin plot)
  stat_halfeye(
    adjust = 0.5,
    width = 0.5,
    alpha = 0.5,
    justification = -0.2,
    .width = 0,
    point_colour = NA,
    position = position_dodge(width = 0.8)  # Add dodge to violin plots
  ) +
  # Add the rain (individual points)
  geom_point(
    position = position_jitterdodge(dodge.width = 0.8, jitter.width = 0.15),
    size = 1,
    alpha = 0.5
  ) +
  # Add boxplot
  geom_boxplot(
    width = 0.1,
    position = position_dodge(width = 0.8),  # Make sure dodge width matches
    outlier.shape = NA,
    alpha = 0.5
  ) +
  # Customize colors
  scale_fill_manual(
    values = c(
      "sated" = "cornflowerblue",
      "hungry" = "gold"
    )
  ) +
  scale_color_manual(
    values = c(
      "sated" = "cornflowerblue",
      "hungry" = "gold"
    )
  ) +
  #geom_hline(yintercept = 0.5, color = "black", linetype = "dashed") +
  labs(y = expression(bold(paste("P(DT"[paste("taste")], ")"))), x = "Condition") +

  myTheme+
  theme(panel.background = element_rect(color = "magenta", linewidth = 2, fill = NA),
        plot.margin = margin(10, 10, 20, 10))
dt_food

ggsave("dwelltime_taste_cond_food.png", width = 7, height = 7, plot = last_plot(), dpi = 300)
```

relevant stats
```{r}
#diff between conditions
att_food_h<-subset(combined_summary_food, condition =='hungry')
att_food_s<-subset(combined_summary_food, condition =='sated')

ttest<-t.test(att_food_h$mean_att_food, att_food_s$mean_att_food, paired=TRUE)
ttest

effect_size3 <- ttest$statistic / sqrt(ttest$parameter)

```



## 3 Social
### 3.1 choose selfish given dwell time option

```{r}
p1 <- ggplot(data_combined_social2, aes(x =(dwelldiff_rel_time), y = choice2, color = condition, fill=condition)) +
    geom_smooth(method = "glm", se = TRUE, 
              aes(fill = condition), method.args = list(family=binomial), alpha = 0.3) +
  scale_color_manual(values = c("gold", "cornflowerblue")) +
  scale_fill_manual(values = c("gold", "cornflowerblue")) +  # Set fill colors for each condition
  labs(x = expression(bold(paste("DT", Delta, "(option"[paste("selfish")], " - option"[paste("prosocial")], ")"))), y = "P(Selfish Choice)") +
  geom_hline(yintercept = 0.5, color = "black", linetype = "dashed") +
  geom_vline(xintercept = 0, color = "black", linetype = "dashed") +  
  ylim(0,1)+
  myTheme+
  theme(panel.background = element_rect(color = "orange", linewidth = 2, fill = NA),
        plot.margin = margin(10, 10, 20, 10))
ggsave("pchoice_dwelltime_social.png",  width = 8, height = 6, plot = last_plot(), dpi = 300)
p1

```

Differences in option DT(selfish - prosocial) between conditions
```{r}
combined_summary_social <- data_combined_social2 %>%
  group_by(subject, condition) %>%
  summarise(mean_att_option = mean(dwelldiff_rel_time),
            mean_att_attribute = mean(rel_dwelldiff_self2))

ttest2<-t.test(combined_summary_social$mean_att_option[combined_summary_social$condition == "hungry"], combined_summary_social$mean_att_option[combined_summary_social$condition == "sated"], paired=TRUE)
ttest2

effect_size_tt2 <- ttest2$statistic / sqrt(ttest2$parameter)
effect_size_tt2

ttest3<-t.test(combined_summary_social$mean_att_attribute[combined_summary_social$condition == "hungry"], combined_summary_social$mean_att_attribute[combined_summary_social$condition == "sated"], paired=TRUE)
ttest3


effect_size_tt3 <- ttest3$statistic / sqrt(ttest3$parameter)
effect_size_tt3

```


### 3.2 choose selfish given dwell time self
add again GLMM to create prediction plot
```{r}
library(lme4)
library(lmerTest)
social_model4 <- glmer(choice2 ~ condition + scl_dwelldiff_rel_time + scl_rel_dwelldiff_self2 + (1 + condition + scl_rel_dwelldiff_self2| subject), data = data_combined_social2, family = binomial(link = "logit"), control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
```


When using the same method s in 3.1 juts on the attribute level, the slope is positive, however, our GLMM indicated a negative efefct of DT(self-ngo)
Why: 
*Prosocial people: Always choose prosocially, barely look at selfish options; low mean_selfDT, low choice rate
*Selfish people: Often choose selfishly, look at selfish options a lot; high mean_selfDT, high choice rate
-->BUT within each person on any given trial:Looking longer at selfish option might indicate conflict; actually choosing the prosocial option after deliberating

For the manuscript we want to tell a straightforward story and show a Figure which reflects the result from the GLMM, therefore, we use prediction data from our GLMM to reflect the predictor of DT(self-NGO) which takes the variability from the random efefcts into account
```{r}
library(merTools)
# Create prediction data frame with a reference subject
reference_subject <- data_combined_social2$subject[1]

pred_data <- expand.grid(
  scl_rel_dwelldiff_self2 = seq(-1, 1, length.out = 100),
  condition = c("sated", "hungry"),
  scl_dwelldiff_rel_time = mean(data_combined_social2$scl_dwelldiff_rel_time, na.rm = TRUE),
  subject = reference_subject
)

# Get predictions using only fixed effects
pred_intervals <- merTools::predictInterval(social_model4, newdata = pred_data, 
                                 level = 0.95, n.sims = 5000,
                                 type = "probability", which = "fixed")

pred_data$predicted <- pred_intervals$fit
pred_data$lower <- pred_intervals$lwr
pred_data$upper <- pred_intervals$upr

n <- 140 # 70*2 
pred_data$se <- sqrt(pred_data$predicted * (1 - pred_data$predicted) / n)

# Create plot
ggplot(pred_data, aes(x = scl_rel_dwelldiff_self2, y = predicted, color = condition)) +
  geom_line(size = 1.2) +
  geom_ribbon(aes(ymin = predicted-se, ymax = predicted+se, fill = condition), 
              alpha = 0.2, color = NA) +
  scale_color_manual(values = c("gold", "cornflowerblue")) +
  scale_fill_manual(values = c("gold", "cornflowerblue")) +
  labs(x = expression(bold(paste("DT", Delta, "(attribute"[paste("self")], " - attribute"[paste("NGO")], ")"))), y = "P(Selfish Choice)") +
  geom_hline(yintercept = 0.5, linetype = "dashed") +
  geom_vline(xintercept = 0, linetype = "dashed") +
  ylim(0,1) +
  myTheme+
  theme(panel.background = element_rect(color = "orange", linewidth = 2, fill = NA),
        plot.margin = margin(10, 10, 20, 10))

ggsave("attributedt_choice_social.png", width = 8, height = 6, plot = last_plot(), dpi = 300)
```


### 3.3 Plot more attention to ngo attribute under hunger?
```{r}
data_combined_social2$att_self <- (data_combined_social2$selfleft_time + data_combined_social2$selfright_time) / data_combined_social2$total_dt

combined_summary <- data_combined_social2 %>%
  group_by(subject, condition) %>%
  summarise(mean_att_self = mean(att_self),
            std_error = sd(att_self) / sqrt(n()))

library(ggdist)

dt_social <- ggplot(combined_summary, aes(x = condition, y = mean_att_self, fill = condition)) +
  # Add the cloud (violin plot)
  stat_halfeye(
    adjust = 0.5,
    width = 0.5,
    alpha = 0.5,
    justification = -0.2,
    .width = 0,
    point_colour = NA,
    position = position_dodge(width = 0.8)  # Add dodge to violin plots
  ) +
  # Add the rain (individual points)
  geom_point(
    position = position_jitterdodge(dodge.width = 0.8, jitter.width = 0.15),
    size = 1,
    alpha = 0.5
  ) +
  # Add boxplot
  geom_boxplot(
    width = 0.1,
    position = position_dodge(width = 0.8),  # Make sure dodge width matches
    outlier.shape = NA,
    alpha = 0.5
  ) +
  # Customize colors
  scale_fill_manual(
    values = c(
      "sated" = "cornflowerblue",
      "hungry" = "gold"
    )
  ) +
  scale_color_manual(
    values = c(
      "sated" = "cornflowerblue",
      "hungry" = "gold"
    )
  ) +
  geom_hline(yintercept = 0.5, color = "black", linetype = "dashed") +
#labs(x = expression(bold(paste("DT", Delta, "(attribute"[paste("self")], " - attribute"[paste("NGO")], ")"))), y = "P(Selfish Choice)") +
  labs(y = expression(bold(paste("P(DT"[paste("self")], ")"))), x = "Condition") +
  # labs(
  #   x = "Condition",
  #   y = "P(DT(self))",
  #   fill = "Condition",
  #   color = "Condition"
  # ) +
  myTheme+
  theme(panel.background = element_rect(color = "orange", linewidth = 2, fill = NA),
        plot.margin = margin(10, 10, 20, 10))
dt_social

ggsave("dwelltime_self_cond_social.png", width = 7, height = 7, plot = last_plot(), dpi = 300)
```


stasts...
```{r}
att_self_h<-subset(combined_summary, condition =='hungry')
att_self_s<-subset(combined_summary, condition =='sated')

ttest<-t.test(att_self_h$mean_att_self, att_self_s$mean_att_self, paired=TRUE)
ttest

effect_size3 <- ttest$statistic / sqrt(ttest$parameter)
effect_size3
# no difference
```



### 3.4 Lets take a look at first and last fixations
```{r}
nsubj <- length(unique(data_combined2$subject))
data_social_hungry_long_w0<-data_social_hungry_long
data_social_sated_long_w0<-data_social_sated_long
data_social_hungry_long<-subset(data_social_hungry_long, fixElement != 0)
data_social_sated_long<-subset(data_social_sated_long, fixElement != 0)
```
#### 3.4.1 Recode for position
```{r}
#Fixated Element code
#1 = self left
#2 = self right
#3 = ngo left
#4 = ngo right

is_odd <- function(x) {
  x %% 2 == 1
}

# recoding function for position (even subjects saw self on upper side of screen and ngo on lower side, while odd subjects the other way around)
recode_fixation <- function(fixElement, subject) {
  ifelse(
    is_odd(x=subject), # For odd subjects, apply the recoding; For even subjects, keep the original fixElement
    dplyr::case_when(
      fixElement == 1 ~ 3,
      fixElement == 2 ~ 4,
      fixElement == 3 ~ 1,
      fixElement == 4 ~ 2,
      TRUE ~ fixElement
    ),
    fixElement  # Return original value for even subjects
  )
}

# Apply to dataframes, such that 
#fixElement2 code
#1 = upper left
#2 = upper right
#3 = lower left
#4 = lower right

# Apply to dataframes using subject column
data_social_hungry_long$fixElement2 <- recode_fixation(data_social_hungry_long$fixElement,data_social_hungry_long$subject)

data_social_sated_long$fixElement2 <- recode_fixation(data_social_sated_long$fixElement,data_social_sated_long$subject)

```

#### 3.4.2 Get first and last fixations for category and postion as well as hungry and sated dataframe
##### 3.4.2.1 hungry
```{r}
library("dplyr")
# Group the data by trial and subject
grouped_social_data_hungry <- data_social_hungry_long %>%
  group_by(trial, subject)

# a) First Fix
# Extract the first fixated element for each trial
first_fix_social_hungry <- grouped_social_data_hungry %>%
  slice(1) %>%
  dplyr::select(trial, first_element_cat = fixElement, first_element_loc = fixElement2)

#category
first_fix_social_hungry_cat<-first_fix_social_hungry %>%
  group_by(first_element_cat) %>%
  summarise(n = n(), fix_prop = n/nrow(first_fix_social_hungry), 
            se_prop = sqrt((fix_prop * (1 - fix_prop)) / nsubj),
            condition = "hungry")
#location
first_fix_social_hungry_loc<-first_fix_social_hungry %>%
  group_by(first_element_loc) %>%
  summarise(n = n(), fix_prop = n/nrow(first_fix_social_hungry), 
            se_prop = sqrt((fix_prop * (1 - fix_prop)) / nsubj),
            condition = "hungry")

# b) Last Fix
# Extract the last fixated element for each trial
last_fix_social_hungry <- grouped_social_data_hungry %>%
  slice(n()) %>%
  dplyr::select(trial, response, last_element_cat = fixElement, last_element_loc = fixElement2)

#category
last_fix_social_hungry_cat<-last_fix_social_hungry %>%
  group_by(last_element_cat) %>%
  summarise(n = n(), fix_prop = n/nrow(last_fix_social_hungry), 
            se_prop = sqrt((fix_prop * (1 - fix_prop)) / nsubj),
            condition = "hungry")
#location
last_fix_social_hungry_loc<-last_fix_social_hungry %>%
  group_by(last_element_loc) %>%
  summarise(n = n(), fix_prop = n/nrow(last_fix_social_hungry), 
            se_prop = sqrt((fix_prop * (1 - fix_prop)) / nsubj),
            condition = "hungry")

```

##### 3.4.2.2 sated
```{r}
# Group the data by trial and subject
grouped_social_data_sated <- data_social_sated_long %>%
  group_by(trial, subject)

# a) First Fix
# Extract the first fixated element for each trial
first_fix_social_sated <- grouped_social_data_sated %>%
  slice(1) %>%
  dplyr::select(trial, first_element_cat = fixElement, first_element_loc = fixElement2)

#category
first_fix_social_sated_cat<-first_fix_social_sated %>%
  group_by(first_element_cat) %>%
  summarise(n = n(), fix_prop = n/nrow(first_fix_social_sated), 
            se_prop = sqrt((fix_prop * (1 - fix_prop)) / nsubj),
            condition = "sated")
#location
first_fix_social_sated_loc<-first_fix_social_sated %>%
  group_by(first_element_loc) %>%
  summarise(n = n(), fix_prop = n/nrow(first_fix_social_sated), 
            se_prop = sqrt((fix_prop * (1 - fix_prop)) / nsubj),
            condition = "sated")

# b) Last Fix
# Extract the last fixated element for each trial
last_fix_social_sated <- grouped_social_data_sated %>%
  slice(n()) %>%
  dplyr::select(trial, response, last_element_cat = fixElement, last_element_loc = fixElement2)

#category
last_fix_social_sated_cat<-last_fix_social_sated %>%
  group_by(last_element_cat) %>%
  summarise(n = n(), fix_prop = n/nrow(last_fix_social_sated), 
            se_prop = sqrt((fix_prop * (1 - fix_prop)) / nsubj),
            condition = "sated")
#location
last_fix_social_sated_loc<-last_fix_social_sated %>%
  group_by(last_element_loc) %>%
  summarise(n = n(), fix_prop = n/nrow(last_fix_social_sated), 
            se_prop = sqrt((fix_prop * (1 - fix_prop)) / nsubj),
            condition = "sated")

```


##### 3.4.2.3 Plot
```{r}
plot_fixation_proportions <- function(hungry_data, sated_data, fixation_type = c("first", "last"), plot_type = c("location", "category"),custom_labels = NULL) {
  
  # Input validation
  fixation_type <- match.arg(fixation_type)
  plot_type <- match.arg(plot_type)
  
    # Get the actual names from the provided lists
  hungry_names <- names(hungry_data)
  sated_names <- names(sated_data)
  
  # Select the appropriate data based on fixation type
  hungry_data_name <- hungry_names[grep(paste0(fixation_type, "_fix"), hungry_names)]
  sated_data_name <- sated_names[grep(paste0(fixation_type, "_fix"), sated_names)]
  
  # Get the data
  hungry_data_to_use <- hungry_data[[hungry_data_name]]
  sated_data_to_use <- sated_data[[sated_data_name]]
  
  # Set the group column name based on fixation type and plot type
  group_col <- if(plot_type == "location") {
    if(fixation_type == "first") "first_element_loc" else "last_element_loc"
  } else {
    if(fixation_type == "first") "first_element_cat" else "last_element_cat"
  }
  
  # Set x-axis label
  x_lab <- if(plot_type == "location") "Location" else "Category"
  
  # Combine the data
  combined_data <- rbind(hungry_data_to_use, sated_data_to_use)
  combined_data[[group_col]] <- as.factor(combined_data[[group_col]])
  
  
  # Create the plot
  plot <- ggplot(combined_data, aes(x = !!sym(group_col), y = fix_prop, fill = condition)) +
    geom_bar(stat = "identity", position = "dodge", width = 0.6) +
    geom_errorbar(aes(ymin = fix_prop - se_prop, ymax = fix_prop + se_prop),position = position_dodge(width = 0.6), width = 0.2, color = "black", alpha = 0.7) +
    geom_hline(yintercept = 0.25, color = "black",linetype = "dashed") +
    xlab(x_lab) +
    ylab("Proportion") +
    #ggtitle("") +
    ylim(0, 1) +
    scale_fill_manual(values = c("sated" = "cornflowerblue", "hungry" = "gold")) +
    myTheme + 
    scale_x_discrete(labels = custom_labels)+
    theme(legend.position="none")

  return(plot)
}
```

```{r}
location_labels <- c("1" ="upper left","2" ="upper right", "3" ="lower left","4" ="lower right")
category_labels <- c("1" = "self left", "2" = "self right", "3" = "NGO left", "4" = "NGO right")

p1 <- plot_fixation_proportions(hungry_data = list(first_fix_social_hungry_loc = first_fix_social_hungry_loc,last_fix_social_hungry_loc = last_fix_social_hungry_loc),
  sated_data = list(first_fix_social_sated_loc = first_fix_social_sated_loc,last_fix_social_sated_loc = last_fix_social_sated_loc),fixation_type = "first",plot_type = "location", custom_labels = location_labels
)
p1
ggsave("prop_firstfix_loc_social.png", p1,  width = 7, height = 7, dpi = 300)

p2 <- plot_fixation_proportions(hungry_data = list(first_fix_social_hungry_loc = first_fix_social_hungry_loc,last_fix_social_hungry_loc = last_fix_social_hungry_loc),
  sated_data = list(first_fix_social_sated_loc = first_fix_social_sated_loc,last_fix_social_sated_loc = last_fix_social_sated_loc),fixation_type = "last",plot_type = "location", custom_labels = location_labels
)
p2
ggsave("prop_lastfix_loc_social.png", p2, width = 7, height = 7, dpi = 300)

p3 <- plot_fixation_proportions(hungry_data = list(first_fix_social_hungry_cat = first_fix_social_hungry_cat,last_fix_social_hungry_cat = last_fix_social_hungry_cat),
  sated_data = list(first_fix_social_sated_cat = first_fix_social_sated_cat,last_fix_social_sated_cat = last_fix_social_sated_cat),fixation_type = "first",plot_type = "category", custom_labels = category_labels
)
p3
ggsave("prop_firstfix_cat_social.png", p3,  width = 7, height = 7, dpi = 300)

p4 <- plot_fixation_proportions(hungry_data = list(first_fix_social_hungry_cat = first_fix_social_hungry_cat,last_fix_social_hungry_cat = last_fix_social_hungry_cat),
  sated_data = list(first_fix_social_sated_cat = first_fix_social_sated_cat,last_fix_social_sated_cat = last_fix_social_sated_cat),fixation_type = "last",plot_type = "category", custom_labels = category_labels
)
p4
ggsave("prop_lastfix_cat_social.png", p4, width = 7, height = 7, dpi = 300)
```


### 3.5 Fixation Transitions
```{r}
create_fixation_transitions <- function(data) {
  data$transition <- 'NA'
  
  for (i in 1:(nrow(data) - 1)) {
    if (((data$fixElement[i] == 1 && data$fixElement[i + 1] == 3) ||
         (data$fixElement[i] == 2 && data$fixElement[i + 1] == 4)) ||
        ((data$fixElement[i] == 3 && data$fixElement[i + 1] == 1) ||
         (data$fixElement[i] == 4 && data$fixElement[i + 1] == 2))) {
      data$transition[i] <- "within alternative"
      
    } else if (((data$fixElement[i] == 1 && data$fixElement[i + 1] == 2) ||
                (data$fixElement[i] == 3 && data$fixElement[i + 1] == 4)) ||
               ((data$fixElement[i] == 2 && data$fixElement[i + 1] == 1) ||
                (data$fixElement[i] == 4 && data$fixElement[i + 1] == 3))) {
      data$transition[i] <- "within attributes"
      
    } else if (((data$fixElement[i] == 1 && data$fixElement[i + 1] == 4) ||
                (data$fixElement[i] == 2 && data$fixElement[i + 1] == 3)) ||
               ((data$fixElement[i] == 4 && data$fixElement[i + 1] == 1) ||
                (data$fixElement[i] == 3 && data$fixElement[i + 1] == 2))) {
      data$transition[i] <- "diagonal"
      
    } else if (((data$fixElement[i] == 1 && data$fixElement[i + 1] == 1) ||
                (data$fixElement[i] == 2 && data$fixElement[i + 1] == 2) ||
                (data$fixElement[i] == 3 && data$fixElement[i + 1] == 3) ||
                (data$fixElement[i] == 4 && data$fixElement[i + 1] == 4))) {
      data$transition[i] <- "remain"
    }
  }
  
  return(data)
}


data_social_hungry_long <- create_fixation_transitions(data_social_hungry_long)
data_social_sated_long <- create_fixation_transitions(data_social_sated_long)
  
```

```{r}
## HUNGRY
# check proportion transitions
## exclude remain trials
data_trans <- subset(data_social_hungry_long, transition!='remain')
data_trans <- subset(data_trans, transition!='NA')
data_trans$condition<- 'hungry'
counts_trans <- table(data_trans$transition)
## SATED
# check proportion transitions
## exclude remain trials
data_transs <- subset(data_social_sated_long, transition!='remain')
data_transs <- subset(data_transs, transition!='NA')
counts_transs <- table(data_transs$transition)
data_transs$condition <- 'sated'

trans_h2 <- data_trans %>%
  group_by(subject, transition) %>%
  summarise(count = n()) %>%
  group_by(subject) %>%
  mutate(prop = count / sum(count),
         std_error = sqrt(prop * (1 - prop) / sum(count))) %>%
  dplyr::select(subject, transition, prop, std_error)
trans_h2$condition<- 'hungry'

trans_s2 <- data_transs %>%
  group_by(subject, transition) %>%
  summarise(count = n()) %>%
  group_by(subject) %>%
  mutate(prop = count / sum(count),
         std_error = sqrt(prop * (1 - prop) / sum(count))) %>%
  dplyr::select(subject, transition, prop, std_error)
trans_s2$condition<- 'sated'


trans_h2 <- subset(trans_h2, subject %in% trans_s2$subject)
trans_s2 <- subset(trans_s2, subject %in% trans_h2$subject)

trans<-rbind(trans_h2, trans_s2)

box_plot<- ggplot(data = trans, aes(x = transition, y = prop, fill = condition)) +
  geom_boxplot(position = position_dodge(width = 0.75)) +
  #geom_hline(yintercept = 0, color = "red") +
  xlab("Transition Type") +
  ylab("Proportion") +
  #ggtitle("Payne index across conditions") +
  scale_fill_manual(values = c("sated" = "cornflowerblue", "hungry" = "gold"))+
  ylim(0, 1)+
  myTheme
box_plot
ggsave("average_transitions2.png", width = 9, height = 7, plot = last_plot(), dpi = 300)

```
... Relevant stats
```{r}
# Create all combinations of subject, condition, and transitions
all_combinations <- expand.grid(
  subject = unique(trans$subject),
  condition = unique(trans$condition),
  transition = unique(trans$transition)
)

# Merge with the original dataframe to fill in missing rows
trans_filled <- merge(all_combinations, trans, by = c("subject", "condition", "transition"), all.x = TRUE)

# Replace missing values with smallest number
trans_filled[is.na(trans_filled)] <- .Machine$double.eps

# Perform statistical tests on the imputed data
# Get unique levels of transition
transition_levels <- unique(trans_filled$transition)

# Create an empty list to store results
wilcox_results <- list()

# Loop through each level of transition
for (level in transition_levels) {
  # Subset the data for the current transition level
  subset_data <- trans_filled[trans_filled$transition == level, ]
  
  # Perform Wilcoxon signed-rank test
  wilcox_result <- wilcox.test(prop ~ condition, data = subset_data)
  
  # Store the result in the list
  wilcox_results[[level]] <- wilcox_result
}

wilcox_results

# summary
library(rstatix)
trans_filled %>%
  group_by(condition, transition) %>%
  get_summary_stats(prop, type = "mean_sd")

## No differences between conditions
```
## 4 Discount
### 4.1 choose impulsive given rel. dwell time (impatient - patient option)
```{r}
p1 <- ggplot(data_combined_discount2, aes(x =(dwelldiff_impatient_rel), y = choice2, color = condition, fill=condition)) +
    geom_smooth(method = "glm", method.args = list(family=binomial), se = TRUE, 
              aes(fill = condition), alpha = 0.3) +
  scale_color_manual(values = c("gold", "cornflowerblue")) +
  scale_fill_manual(values = c("gold", "cornflowerblue")) +  # Set fill colors for each condition
  labs(x = expression(bold(paste("DT", Delta, "(option"[paste("impatient")], " - option"[paste("patient")], ")"))), y = "P(Impatient Choice)") +
  geom_hline(yintercept = 0.5, color = "black", linetype = "dashed") +
  geom_vline(xintercept = 0, color = "black", linetype = "dashed") +  
  ylim(0,1)+
  myTheme+
  theme(panel.background = element_rect(color = "#00FFFF", linewidth = 2, fill = NA),
        plot.margin = margin(10, 10, 20, 10))

ggsave("pchoice_dwelltime_discount.png",  width = 8, height = 6, plot = last_plot(), dpi = 300)
p1

```

Differnece in attention to options based on hunger state
```{r}
combined_summary_discount <- data_combined_discount2 %>%
  group_by(subject, condition) %>%
  summarise(mean_att_option = mean(dwelldiff_impatient_rel),
            mean_att_attribute = mean(rel_dwelldiff_delay))


ttest4<-t.test(combined_summary_discount$mean_att_option[combined_summary_discount$condition == "hungry"], combined_summary_discount$mean_att_option[combined_summary_discount$condition == "sated"], paired=TRUE)
ttest4

effect_size_tt4 <- ttest4$statistic / sqrt(ttest4$parameter)
effect_size_tt4

ttest5<-t.test(combined_summary_discount$mean_att_attribute[combined_summary_discount$condition == "hungry"], combined_summary_discount$mean_att_attribute[combined_summary_discount$condition == "sated"], paired=TRUE)
ttest5

effect_size_tt5 <- ttest5$statistic / sqrt(ttest5$parameter)
effect_size_tt5
```

### 4.2 choose impulsive given rel. dwell time (delay - amount attribute)
same approach as in social to reflect predictor of GLMM (taking random efefcts structure into account, rather than population level effects)
```{r}
discount_model4 <- glmer(choice2~condition + scale(dwelldiff_impatient_rel) +scale(rel_dwelldiff_delay) + (1+condition+scale(rel_dwelldiff_delay)|subject), data=data_combined_discount2, family=binomial(link="logit"), control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

```

```{r}
# Create prediction data frame with a reference subject
reference_subject2 <- data_combined_discount2$subject[1]

pred_data2 <- expand.grid(
  rel_dwelldiff_delay = seq(-1, 1, length.out = 100),
  condition = c("sated","hungry"),
  dwelldiff_impatient_rel = mean(data_combined_discount2$scl_dwelldiff_impatient_rel, na.rm = TRUE),
  subject = reference_subject2
)

# Get predictions using only fixed effects (ignoring the random effects)
pred_intervals2 <- merTools::predictInterval(discount_model4, newdata = pred_data2, 
                                 level = 0.95, n.sims = 5000,
                                 type = "probability", which = "fixed")

pred_data2$predicted <- pred_intervals2$fit
pred_data2$lower <- pred_intervals2$lwr
pred_data2$upper <- pred_intervals2$upr
pred_data2$se <- sqrt(pred_data2$predicted * (1 - pred_data2$predicted) / n)

# Create plot
ggplot(pred_data2, aes(x = rel_dwelldiff_delay, y = predicted, color = condition)) +
  geom_line(size = 1.2) +
  geom_ribbon(aes(ymin = predicted-se, ymax = predicted+se, fill = condition), 
              alpha = 0.2, color = NA) +
  scale_color_manual(values = c("gold", "cornflowerblue")) +
  scale_fill_manual(values = c("gold", "cornflowerblue")) +
  labs(x = expression(bold(paste("DT", Delta, "(attribute"[paste("delay")], " - attribute"[paste("amount")], ")"))), y = "P(Impatient Choice)") +
  geom_hline(yintercept = 0.5, linetype = "dashed") +
  geom_vline(xintercept = 0, linetype = "dashed") +
  ylim(0,1) +
  myTheme+
  theme(panel.background = element_rect(color = "#00FFFF", linewidth = 2, fill = NA),
        plot.margin = margin(10, 10, 20, 10))

ggsave("attributedt_choice_discount.png",  width = 8, height = 6, plot = last_plot(), dpi = 300)
```


### 4.3 Plot more attention to delay attribute under hunger?
```{r}

data_combined_discount2$att_delay <- (data_combined_discount2$delayleft_time + data_combined_discount2$delayright_time) /
                ((data_combined_discount2$delayleft_time + data_combined_discount2$delayright_time +
                    data_combined_discount2$amountleft_time + data_combined_discount2$amountright_time))

#delete NA trials
data_combined_discount3 <- subset(data_combined_discount2,att_delay!='NaN')

combined_summary_disc <- data_combined_discount3 %>%
  group_by(subject, condition) %>%
  summarise(mean_att_delay = mean(att_delay),
            std_error = sd(att_delay) / sqrt(n()))


dt_delay <- ggplot(combined_summary_disc, aes(x = condition, y = mean_att_delay, fill = condition)) +
  # Add the cloud (violin plot)
  stat_halfeye(
    adjust = 0.5,
    width = 0.5,
    alpha = 0.5,
    justification = -0.2,
    .width = 0,
    point_colour = NA,
    position = position_dodge(width = 0.8)  # Add dodge to violin plots
  ) +
  # Add the rain (individual points)
  geom_point(
    position = position_jitterdodge(dodge.width = 0.8, jitter.width = 0.15),
    size = 1,
    alpha = 0.5
  ) +
  # Add boxplot
  geom_boxplot(
    width = 0.1,
    position = position_dodge(width = 0.8),  # Make sure dodge width matches
    outlier.shape = NA,
    alpha = 0.5
  ) +
  # Customize colors
  scale_fill_manual(
    values = c(
      "sated" = "cornflowerblue",
      "hungry" = "gold"
    )
  ) +
  scale_color_manual(
    values = c(
      "sated" = "cornflowerblue",
      "hungry" = "gold"
    )
  ) +
  geom_hline(yintercept = 0.5, color = "black", linetype = "dashed") +
  labs(y = expression(bold(paste("P(DT"[paste("delay")], ")"))), x = "Condition") +

  myTheme+
  theme(panel.background = element_rect(color = "#00FFFF", linewidth = 2, fill = NA),
        plot.margin = margin(10, 10, 20, 10))
dt_delay

ggsave("dwelltime_delay_cond_discount.png", width = 7, height = 7, plot = last_plot(), dpi = 300)
```

stats...
```{r}
#diff between conditions
att_delay_h<-subset(combined_summary_disc, condition =='hungry')
att_delay_s<-subset(combined_summary_disc, condition =='sated')

ttest<-t.test(att_delay_h$mean_att_delay, att_delay_s$mean_att_delay, paired=TRUE)
ttest

effect_size3 <- ttest$statistic / sqrt(ttest$parameter)
effect_size3
#different that .5?
ttest_h <- t.test(att_delay_h$mean_att_delay, mu = 0.5)
ttest_h

# Conduct a one-sample t-test for the second condition (att_delay_s)
ttest_s <- t.test(att_delay_s$mean_att_delay, mu = 0.5)
ttest_s
# no difference between conditions, but participants spent significantly more time on the amount attribute in both conditions!
```



### 4.4 Lets take a look at first and last fixations
Function to categorise where (location and content participants looked when)
```{r}
data_discount_hungry_long_w0<-data_discount_hungry_long
data_discount_sated_long_w0<-data_discount_sated_long
data_discount_hungry_long<-subset(data_discount_hungry_long, fixElement != 0)
data_discount_sated_long<-subset(data_discount_sated_long, fixElement != 0)
```
#### 4.4.1 Recode for position
```{r}
#Fixated Element code
#1 = time left
#2 = time right
#3 = amount left
#4 = amount right

is_even <- function(x) {
  x %% 2 == 1
}

# recoding function for position (odd subjects saw value on upper side of screen and time on lower side, while odd subjects the other way around)
recode_fixation2 <- function(fixElement, subject) {
  ifelse(
    is_even(subject),
    dplyr::case_when(
      fixElement == 1 ~ 3,
      fixElement == 2 ~ 4,
      fixElement == 3 ~ 1,
      fixElement == 4 ~ 2,
      TRUE ~ fixElement
    ),
    fixElement  # Return original value for even subjects
  )
}

# Apply to dataframes, such that
#fixElement2 code
#1 = upper left
#2 = upper right
#3 = lower left
#4 = lower right
data_discount_hungry_long$fixElement2 <- recode_fixation2(data_discount_hungry_long$fixElement, data_discount_hungry_long$subject)
data_discount_sated_long$fixElement2 <- recode_fixation2(data_discount_sated_long$fixElement, data_discount_sated_long$subject)

```

#### 4.4.2 Get first and last fixations for category and postion as well as hungry and sated dataframe

##### 4.4.2.1 hungry
```{r}
# Group the data by trial and subject
grouped_discount_data_hungry <- data_discount_hungry_long %>%
  group_by(trial, subject)

# a) First Fix
# Extract the first fixated element for each trial
first_fix_discount_hungry <- grouped_discount_data_hungry %>%
  slice(1) %>%
  dplyr::select(trial, first_element_cat = fixElement, first_element_loc = fixElement2)

#category
first_fix_discount_hungry_cat<-first_fix_discount_hungry %>%
  group_by(first_element_cat) %>%
  summarise(n = n(), fix_prop = n/nrow(first_fix_discount_hungry), 
            se_prop = sqrt((fix_prop * (1 - fix_prop)) / nsubj),
            condition = "hungry")
#location
first_fix_discount_hungry_loc<-first_fix_discount_hungry %>%
  group_by(first_element_loc) %>%
  summarise(n = n(), fix_prop = n/nrow(first_fix_discount_hungry), 
            se_prop = sqrt((fix_prop * (1 - fix_prop)) / nsubj),
            condition = "hungry")

# b) Last Fix
# Extract the last fixated element for each trial
last_fix_discount_hungry <- grouped_discount_data_hungry %>%
  slice(n()) %>%
  dplyr::select(trial, response, last_element_cat = fixElement, last_element_loc = fixElement2)

#category
last_fix_discount_hungry_cat<-last_fix_discount_hungry %>%
  group_by(last_element_cat) %>%
  summarise(n = n(), fix_prop = n/nrow(last_fix_discount_hungry), 
            se_prop = sqrt((fix_prop * (1 - fix_prop)) / nsubj),
            condition = "hungry")
#location
last_fix_discount_hungry_loc<-last_fix_discount_hungry %>%
  group_by(last_element_loc) %>%
  summarise(n = n(), fix_prop = n/nrow(last_fix_discount_hungry), 
            se_prop = sqrt((fix_prop * (1 - fix_prop)) / nsubj),
            condition = "hungry")

```

##### 4.4.2.2 sated
```{r}
# Group the data by trial and subject
grouped_discount_data_sated <- data_discount_sated_long %>%
  group_by(trial, subject)

# a) First Fix
# Extract the first fixated element for each trial
first_fix_discount_sated <- grouped_discount_data_sated %>%
  slice(1) %>%
  dplyr::select(trial, first_element_cat = fixElement, first_element_loc = fixElement2)

#category
first_fix_discount_sated_cat<-first_fix_discount_sated %>%
  group_by(first_element_cat) %>%
  summarise(n = n(), fix_prop = n/nrow(first_fix_discount_sated), 
            se_prop = sqrt((fix_prop * (1 - fix_prop)) / nsubj),
            condition = "sated")
#location
first_fix_discount_sated_loc<-first_fix_discount_sated %>%
  group_by(first_element_loc) %>%
  summarise(n = n(), fix_prop = n/nrow(first_fix_discount_sated), 
            se_prop = sqrt((fix_prop * (1 - fix_prop)) / nsubj),
            condition = "sated")

# b) Last Fix
# Extract the last fixated element for each trial
last_fix_discount_sated <- grouped_discount_data_sated %>%
  slice(n()) %>%
  dplyr::select(trial, response, last_element_cat = fixElement, last_element_loc = fixElement2)

#category
last_fix_discount_sated_cat<-last_fix_discount_sated %>%
  group_by(last_element_cat) %>%
  summarise(n = n(), fix_prop = n/nrow(last_fix_discount_sated), 
            se_prop = sqrt((fix_prop * (1 - fix_prop)) / nsubj),
            condition = "sated")
#location
last_fix_discount_sated_loc<-last_fix_discount_sated %>%
  group_by(last_element_loc) %>%
  summarise(n = n(), fix_prop = n/nrow(last_fix_discount_sated), 
            se_prop = sqrt((fix_prop * (1 - fix_prop)) / nsubj),
            condition = "sated")

```
##### 4.4.2.3 Plottings
```{r}
location_labels <- c("1" ="upper left","2" ="upper right", "3" ="lower left","4" ="lower right")
category_labels <- c("1" = "amount left", "2" = "amount right", "3" = "delay left", "4" = "delay right")

p5 <- plot_fixation_proportions(hungry_data = list(first_fix_discount_hungry_loc = first_fix_discount_hungry_loc,last_fix_discount_hungry_loc = last_fix_discount_hungry_loc),
  sated_data = list(first_fix_discount_sated_loc = first_fix_discount_sated_loc,last_fix_discount_sated_loc = last_fix_discount_sated_loc),fixation_type = "first",plot_type = "location", custom_labels = location_labels
)
p5
ggsave("prop_firstfix_loc_discount.png", p5, width = 7, height = 7, dpi = 300)

p6 <- plot_fixation_proportions(hungry_data = list(first_fix_discount_hungry_loc = first_fix_discount_hungry_loc,last_fix_discount_hungry_loc = last_fix_discount_hungry_loc),
  sated_data = list(first_fix_discount_sated_loc = first_fix_discount_sated_loc,last_fix_discount_sated_loc = last_fix_discount_sated_loc),fixation_type = "last",plot_type = "location", custom_labels = location_labels
)
p6
ggsave("prop_lastfix_loc_discount.png", p6, width = 7, height = 7, dpi = 300)

p7 <- plot_fixation_proportions(hungry_data = list(first_fix_discount_hungry_cat = first_fix_discount_hungry_cat,last_fix_discount_hungry_cat = last_fix_discount_hungry_cat),
  sated_data = list(first_fix_discount_sated_cat = first_fix_discount_sated_cat,last_fix_discount_sated_cat = last_fix_discount_sated_cat),fixation_type = "first",plot_type = "category", custom_labels = category_labels
)
p7
ggsave("prop_firstfix_cat_discount.png", p7, width = 7, height = 7, dpi = 300)

p8 <- plot_fixation_proportions(hungry_data = list(first_fix_discount_hungry_cat = first_fix_discount_hungry_cat,last_fix_discount_hungry_cat = last_fix_discount_hungry_cat),
  sated_data = list(first_fix_discount_sated_cat = first_fix_discount_sated_cat,last_fix_discount_sated_cat = last_fix_discount_sated_cat),fixation_type = "last",plot_type = "category", custom_labels = category_labels
)
p8
ggsave("prop_lastfix_cat_discount.png", p8, width = 7, height = 7, dpi = 300)
```


### 4.4.3 Fixation transitions
```{r}
data_discount_hungry_long <- create_fixation_transitions(data_discount_hungry_long)
data_discount_sated_long <- create_fixation_transitions(data_discount_sated_long)
## HUNGRY
# check proportion transitions
## exclude remain trials
data_trans <- subset(data_discount_hungry_long, transition!='remain')
data_trans <- subset(data_trans, transition!='NA')
data_trans$condition<- 'hungry'
counts_trans <- table(data_trans$transition)
## SATED
# check proportion transitions
## exclude remain trials
data_transs <- subset(data_discount_sated_long, transition!='remain')
data_transs <- subset(data_transs, transition!='NA')
counts_transs <- table(data_transs$transition)
data_transs$condition <- 'sated'

trans_h2 <- data_trans %>%
  group_by(subject, transition) %>%
  summarise(count = n()) %>%
  group_by(subject) %>%
  mutate(prop = count / sum(count),
         std_error = sqrt(prop * (1 - prop) / sum(count))) %>%
  dplyr::select(subject, transition, prop, std_error)
trans_h2$condition<- 'hungry'

trans_s2 <- data_transs %>%
  group_by(subject, transition) %>%
  summarise(count = n()) %>%
  group_by(subject) %>%
  mutate(prop = count / sum(count),
         std_error = sqrt(prop * (1 - prop) / sum(count))) %>%
  dplyr::select(subject, transition, prop, std_error)
trans_s2$condition<- 'sated'


trans_h2 <- subset(trans_h2, subject %in% trans_s2$subject)
trans_s2 <- subset(trans_s2, subject %in% trans_h2$subject)

trans<-rbind(trans_h2, trans_s2)

box_plot<- ggplot(data = trans, aes(x = transition, y = prop, fill = condition)) +
  geom_boxplot(position = position_dodge(width = 0.75)) +
  #geom_hline(yintercept = 0, color = "red") +
  xlab("Transition Type") +
  ylab("Proportion") +
  #ggtitle("Payne index across conditions") +
  scale_fill_manual(values = c("sated" = "cornflowerblue", "hungry" = "gold"))+
  ylim(0, 1)+
  myTheme
box_plot
ggsave("average_transitions_discount.png", width = 9, height = 7, plot = last_plot(), dpi = 300)

```


#### 4.4.3 First and last Fixations food

```{r}
nsubj <- length(unique(data_combined2$subject))
data_hungry_long_w0<-data_hungry_long
data_sated_long_w0<-data_sated_long
data_hungry_long<-subset(data_hungry_long, fixElement != 0)
data_sated_long<-subset(data_sated_long, fixElement != 0)
```
#### 2.3.1 Recode for position
```{r}
#Fixated Element code
#1 = food left
#2 = food right
#3 = nutri left
#4 = nutri right

is_odd <- function(x) {
  x %% 2 == 1
}

# recoding function for position (even subjects saw self on upper side of screen and ngo on lower side, while odd subjects the other way around)
recode_fixation <- function(fixElement, subject) {
  ifelse(
    is_odd(x=subject), # For odd subjects, apply the recoding; For even subjects, keep the original fixElement
    dplyr::case_when(
      fixElement == 1 ~ 3,
      fixElement == 2 ~ 4,
      fixElement == 3 ~ 1,
      fixElement == 4 ~ 2,
      TRUE ~ fixElement
    ),
    fixElement  # Return original value for even subjects
  )
}

# Apply to dataframes, such that 
#fixElement2 code
#1 = upper left
#2 = upper right
#3 = lower left
#4 = lower right

# Apply to dataframes using subject column
data_hungry_long$fixElement2 <- recode_fixation(data_hungry_long$fixElement,data_hungry_long$subject)

data_sated_long$fixElement2 <- recode_fixation(data_sated_long$fixElement,data_sated_long$subject)

```


```{r}

# Group the data by trial and subject
grouped_data_hungry <- data_hungry_long %>%
  group_by(trial, subject)

# a) First Fix
# Extract the first fixated element for each trial
first_fix_hungry <- grouped_data_hungry %>%
  slice(1) %>%
  dplyr::select(trial, first_element_cat = fixElement, first_element_loc = fixElement2)

#category
first_fix_hungry_cat<-first_fix_hungry %>%
  group_by(first_element_cat) %>%
  summarise(n = n(), fix_prop = n/nrow(first_fix_hungry), 
            se_prop = sqrt((fix_prop * (1 - fix_prop)) / nsubj),
            condition = "hungry")
#location
first_fix_hungry_loc<-first_fix_hungry %>%
  group_by(first_element_loc) %>%
  summarise(n = n(), fix_prop = n/nrow(first_fix_hungry), 
            se_prop = sqrt((fix_prop * (1 - fix_prop)) / nsubj),
            condition = "hungry")

# b) Last Fix
# Extract the last fixated element for each trial
last_fix_hungry <- grouped_data_hungry %>%
  slice(n()) %>%
  dplyr::select(trial, response, last_element_cat = fixElement, last_element_loc = fixElement2)

#category
last_fix_hungry_cat<-last_fix_hungry %>%
  group_by(last_element_cat) %>%
  summarise(n = n(), fix_prop = n/nrow(last_fix_hungry), 
            se_prop = sqrt((fix_prop * (1 - fix_prop)) / nsubj),
            condition = "hungry")
#location
last_fix_hungry_loc<-last_fix_hungry %>%
  group_by(last_element_loc) %>%
  summarise(n = n(), fix_prop = n/nrow(last_fix_social_hungry), 
            se_prop = sqrt((fix_prop * (1 - fix_prop)) / nsubj),
            condition = "hungry")

```

```{r}
# Group the data by trial and subject
grouped_data_sated <- data_sated_long %>%
  group_by(trial, subject)

# a) First Fix
# Extract the first fixated element for each trial
first_fix_sated <- grouped_data_sated %>%
  slice(1) %>%
  dplyr::select(trial, first_element_cat = fixElement, first_element_loc = fixElement2)

#category
first_fix_sated_cat<-first_fix_sated %>%
  group_by(first_element_cat) %>%
  summarise(n = n(), fix_prop = n/nrow(first_fix_sated), 
            se_prop = sqrt((fix_prop * (1 - fix_prop)) / nsubj),
            condition = "sated")
#location
first_fix_sated_loc<-first_fix_sated %>%
  group_by(first_element_loc) %>%
  summarise(n = n(), fix_prop = n/nrow(first_fix_sated), 
            se_prop = sqrt((fix_prop * (1 - fix_prop)) / nsubj),
            condition = "sated")

# b) Last Fix
# Extract the last fixated element for each trial
last_fix_sated <- grouped_data_sated %>%
  slice(n()) %>%
  dplyr::select(trial, response, last_element_cat = fixElement, last_element_loc = fixElement2)

#category
last_fix_sated_cat<-last_fix_sated %>%
  group_by(last_element_cat) %>%
  summarise(n = n(), fix_prop = n/nrow(last_fix_sated), 
            se_prop = sqrt((fix_prop * (1 - fix_prop)) / nsubj),
            condition = "sated")
#location
last_fix_sated_loc<-last_fix_sated %>%
  group_by(last_element_loc) %>%
  summarise(n = n(), fix_prop = n/nrow(last_fix_sated), 
            se_prop = sqrt((fix_prop * (1 - fix_prop)) / nsubj),
            condition = "sated")

```

```{r}
location_labels <- c("1" ="upper left","2" ="upper right", "3" ="lower left","4" ="lower right")
category_labels <- c("1" = "food left", "2" = "food right", "3" = "nutri left", "4" = "nutri right")

p9 <- plot_fixation_proportions(hungry_data = list(first_fix_hungry_loc = first_fix_hungry_loc,last_fix_hungry_loc = last_fix_hungry_loc),
  sated_data = list(first_fix_sated_loc = first_fix_sated_loc,last_fix_sated_loc = last_fix_sated_loc),fixation_type = "first",plot_type = "location", custom_labels = location_labels
)
p9
ggsave("prop_firstfix_loc_food.png", p9, width = 7, height = 7, dpi = 300)

p10 <- plot_fixation_proportions(hungry_data = list(first_fix_hungry_loc = first_fix_hungry_loc,last_fix_hungry_loc = last_fix_hungry_loc),
  sated_data = list(first_fix_sated_loc = first_fix_sated_loc,last_fix_sated_loc = last_fix_sated_loc),fixation_type = "last",plot_type = "location", custom_labels = location_labels
)
p10
ggsave("prop_lastfix_loc_food.png", p10, width = 7, height = 7, dpi = 300)

p11 <- plot_fixation_proportions(hungry_data = list(first_fix_hungry_cat = first_fix_hungry_cat,last_fix_hungry_cat = last_fix_hungry_cat),
  sated_data = list(first_fix_sated_cat = first_fix_sated_cat,last_fix_sated_cat = last_fix_sated_cat),fixation_type = "first",plot_type = "category", custom_labels = category_labels
)
p11
ggsave("prop_firstfix_cat_food.png", p11, width = 7, height = 7, dpi = 300)

p12 <- plot_fixation_proportions(hungry_data = list(first_fix_hungry_cat = first_fix_hungry_cat,last_fix_hungry_cat = last_fix_hungry_cat),
  sated_data = list(first_fix_sated_cat = first_fix_sated_cat,last_fix_sated_cat = last_fix_sated_cat),fixation_type = "last",plot_type = "category", custom_labels = category_labels
)
p12
ggsave("prop_lastfix_cat_food.png", p12, width = 7, height = 7, dpi = 300)
```
Transitions
```{r}
data_hungry_long <- create_fixation_transitions(data_hungry_long)
data_sated_long <- create_fixation_transitions(data_sated_long)
## HUNGRY
# check proportion transitions
## exclude remain trials
data_trans <- subset(data_hungry_long, transition!='remain')
data_trans <- subset(data_trans, transition!='NA')
data_trans$condition<- 'hungry'
counts_trans <- table(data_trans$transition)
## SATED
# check proportion transitions
## exclude remain trials
data_transs <- subset(data_sated_long, transition!='remain')
data_transs <- subset(data_transs, transition!='NA')
counts_transs <- table(data_transs$transition)
data_transs$condition <- 'sated'

trans_h2 <- data_trans %>%
  group_by(subject, transition) %>%
  summarise(count = n()) %>%
  group_by(subject) %>%
  mutate(prop = count / sum(count),
         std_error = sqrt(prop * (1 - prop) / sum(count))) %>%
  dplyr::select(subject, transition, prop, std_error)
trans_h2$condition<- 'hungry'

trans_s2 <- data_transs %>%
  group_by(subject, transition) %>%
  summarise(count = n()) %>%
  group_by(subject) %>%
  mutate(prop = count / sum(count),
         std_error = sqrt(prop * (1 - prop) / sum(count))) %>%
  dplyr::select(subject, transition, prop, std_error)
trans_s2$condition<- 'sated'


trans_h2 <- subset(trans_h2, subject %in% trans_s2$subject)
trans_s2 <- subset(trans_s2, subject %in% trans_h2$subject)

trans<-rbind(trans_h2, trans_s2)

box_plot<- ggplot(data = trans, aes(x = transition, y = prop, fill = condition)) +
  geom_boxplot(position = position_dodge(width = 0.75)) +
  #geom_hline(yintercept = 0, color = "red") +
  xlab("Transition Type") +
  ylab("Proportion") +
  #ggtitle("Payne index across conditions") +
  scale_fill_manual(values = c("sated" = "cornflowerblue", "hungry" = "gold"))+
  ylim(0, 1)+
  myTheme
box_plot
ggsave("average_transitions_food.png", width = 9, height = 7, plot = last_plot(), dpi = 300)

```

